name: Create GitHub Release

on:
  push:
    branches:
      - main

jobs:
  create-release:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3
        with:
          ref: main

      - name: Get Latest Commit Message
        id: get-commit-message
        run: echo "COMMIT_MESSAGE=$(git log -1 --pretty=%B)" >> $GITHUB_ENV

      - name: Create GitHub Release
        id: create-release
        run: |
          commit_message="${{ env.COMMIT_MESSAGE }}"
          tag_name="v$(echo $commit_message | grep -o -E "v[0-9]+\.[0-9]+\.[0-9]+(-\w+\.\d+\.\d+\.\d+)?" || true)"

          # Check if the commit message contains "alpha" and set the prerelease flag accordingly
          if [[ $commit_message == *"alpha"* ]]; then
            prerelease="true"
          else
            prerelease="false"
          fi

          release_title="Release $tag_name"
          release_notes="This is the release notes for $tag_name"

          echo "Creating GitHub release..."
          echo "Tag Name: $tag_name"
          echo "Release Title: $release_title"
          echo "Release Notes: $release_notes"
          echo "Is Pre-Release: $prerelease"

          response=$(curl -X POST "https://api.github.com/repos/${GITHUB_REPOSITORY}/releases" \
            -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
            -H "Content-Type: application/json" \
            -d '{
              "tag_name": "'"$tag_name"'",
              "name": "'"$release_title"'",
              "body": "'"$release_notes"'",
              "draft": false,
              "prerelease": '"$prerelease"'
            }')

          echo "GitHub release created."
          echo "Response:"
          echo "$response"

        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
